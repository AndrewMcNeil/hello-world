#Sports Betting Data

###Load Packages
```{r}
library(tidyverse)
```
##Store table documentation in list
```{r}
documentation = list(league = "Each row has a unique integer ID 
Each league has conferences and each conference has divisions
This hierarchical structure is implemented with the field parentID
For example, the NFL has ID=2 I
It is at the top of the hierarchy and has no parent
The National Football Conference is a conference within the NFL and has a unique ID=8 - It's parentID=2
The NFC North Division is a division within the National Football Conference
It has unique ID=13 and a parentID=8",
                     team = "Each record has a unique ID
LeaguePartID is a foreign key connecting the team to the LeaguePart table
Points to the Division in which the team plays
This is the CURRENT division in which the team plays
This is important, because, in college, teams frequently move between divisions / conferences
I will be sending you another table that tracks the movement of teams
leaugeID is also a foreign key to the LeaguePart table, pointing to the league in which the team plays
This field introduces redundant data into the table",
                     previous_division = "This table tracks the changes in the division in which a team plays
teamID is a foreign key to the Team table - the Team to which this record applies
divisionID - foreign key to the LeaguePart table - the team played in this division in the past 
(LeaguePartID) in the Team table identifies the division in which the team is playing currently
finalSeason - the final season in which teamID played in divisionID",
                     team_alias = "I use this table when scraping to translate 
the team name that I find on the internet into a team in my database
I query this table for the alias and then using the TeamID I can find the team in my database
Part of my system is for maintaining this table
Every time I find a name on the internet that I don't have in my TeamAlias table y system alerts me
I have to associate the internet team with a team in my database (manually) and then save the corresponding TeamAlias",
                     season = "I maintain this table manually and use it to control
various aspects of the processing within my system",
                     game = "These are the games that I have scraped
after doing a fair bit of cleaning and calculation of additional values
There is quite a bit of redundant data in the tables so that I don't need to keep calculating it
The prefix h and v mean home and visitor (eg., hTeamID=home teamID, vScore=visitor's score, etc.)",
                     line = "Games can have associated betting Lines
Some games will not have a line (most do have) and many games will have more than one Line record
When I scrape games, I save the opening line (if I can find it) and any time I scrape the same game again 
(which happens at least twice) if the line has changed, I save a new line record
The field asOfDateTime contains the date/time when the line was scraped
gameID is the foreign key that connects the line to the Game",
                     game_team = "I create the GameTeam records for performance reasons
For each Game, there are two GameTeam records, one for each of the team
When I am creating features, etc. I use data from the GameTeam records")
```
##Import Data Sets

###League Part Table
```{r}
league_part <- read_csv("/Users/mcneil/desktop/Betting Data/LeaguePart.csv", skip = 1, col_names = c("league_part_id", "code", "name", "parent_id", "is_league", "is_conference", "is_division"), col_types = c("iccciii"))
```
###Team Table
```{r}
team <- read_csv("/Users/mcneil/desktop/Betting Data/Team.csv", col_names = c("team_id", "location", "name", "league_part_id", "league_id", "short_name"), col_types = c("icciic"))
team$team_id[1] <- 1L

```
###Previous Division Table
```{r}
previous_division <- read_csv("/Users/mcneil/desktop/Betting Data/PreviousDivision.csv", col_names = c("id", "team_id", "division_id", "final_season"))
```
###Team Alias Table
```{r}
team_alias <- read_csv("/Users/mcneil/desktop/Betting Data/TeamAlias.csv", col_names = c("id", "team_id", "alias"))
```
###Season Table
```{r}
season <- read_csv("/Users/mcneil/desktop/Betting Data/Season.csv", col_names = FALSE)
```
###Game Table
```{r}
game <- read_csv("/Users/mcneil/desktop/Betting Data/Game.csv", col_names = FALSE)
```
###Line Table
```{r}
line_tbl <- read_csv("/Users/mcneil/desktop/Betting Data/Line.csv", col_names = c("line_id", "game_id", "h_spread",   "v_spread", "total", "h_money", "v_money", "is_pickem", "as_of_date_time", "source", "is_opening_line"))
line_tbl$line_id <- as.integer(line_tbl$line_id)
line_tbl$line_id[1] <- 1919L
```
###Game Team Table
```{r}
game_team <- read_csv("/Users/mcneil/desktop/Betting Data/GameTeam.csv", col_names = c("game_team_id", "game_id", "team_id", "opp_id", "league_id", "is_conference_game", "is_division_game", "team_at_home", "team_is_favored", "has_spread_line", "spread_line", "has_total_line", "total_line", "team_score_ad", "opp_score_ad", "is_playoff_game", "days_rest", "travel_required", "has_money_line", "money_line", "team_score", "opp_score", "season_game_no", "season_week_no", "season", "game_date", "week", "opp_season_game_no"))
game_team$game_team_id <- as.integer(game_team$game_team_id)
game_team$game_team_id[1] <- 30006L
```
###Filter tables to include only NFL games
```{r}
team_nfl <- team %>%
  filter(league_id == 2)
game_team_nfl <- game_team %>%
  filter(league_id == 2)
line_tbl_nfl <- line_tbl %>%
  semi_join(line_tbl, game_team_nfl, by = "game_id")
```
###Create table contataining variables of interest
```{r}
game_stats <- game_team_nfl %>%
  inner_join(team_nfl, by = "team_id") %>%
  select(game_team_id, game_id, team_id, opp_id, money_line, team_score, opp_score, team_at_home, team_is_favored,              travel_required, season, season_week_no, game_date, location, name) 
game_stats
```
###Filter game_stats table to have only favoured teams - add money_line win proportion variable
```{r}
game_stats_favoured <- game_stats %>%
  filter(money_line < 0) %>%
  mutate(money_line_dec = 100 / abs(money_line), team_win = as.integer(team_score > opp_score)) %>%
  arrange(money_line)
game_stats_favoured  
```
###Filter game_stats table to have only unfavoured teams - add money_line win proportion variable
```{r}
game_stats_unfavoured <- game_stats %>%
  filter(money_line > 0) %>%
  mutate(money_line_dec = money_line / 100, team_win = as.integer(team_score > opp_score)) %>%
  arrange(desc(money_line))
game_stats_unfavoured
```
###Combine filtered game_stats tables into game_stats2
```{r}
game_stats2 <- game_stats_favoured %>%
  union(game_stats_unfavoured) %>%
  select(3,4,16,17,8,10,1,2,5,6,7,9,11,12,13,14,15) %>%
  arrange(money_line_dec) %>%
  mutate(team_win_ratio = team_score / opp_score)
game_stats2
```
##Explore the data
###Is there a relationship between team_win and team_is_favoured?
```{r}
table(game_stats2$team_win, game_stats2$team_is_favored) #favoured team win ~2x more than unfavoured
ggplot(game_stats2, aes(x = factor(team_is_favored), y = factor(team_win), col = factor(team_win))) +
  geom_jitter(alpha = 0.7, shape = 1) 
```
###Does the relationship strengthen if only large money_lines are included?
```{r}
game_stats2_filtered <- game_stats2 %>%
  filter(money_line > 500 | money_line < -500) 
table(game_stats2_filtered$team_win, game_stats2_filtered$team_is_favored) #favoured teams win ~9x more than unfavoured
game_stats2_filtered %>%
  ggplot(aes(x = factor(team_is_favored), y = factor(team_win), col = factor(team_win))) +
  geom_jitter() 
```
###Is there a relationship between money_line_dec and team_win? 
```{r}
game_stats2 %>% 
  ggplot(aes(x = log(money_line_dec), y = factor(team_win), col = factor(team_win))) +
  geom_jitter(alpha = 0.4) 
```
###How does the relationship change if only high and low money lines are included? 
```{r}
game_stats2 %>% 
  filter(money_line > 500 | money_line < -500) %>%
  ggplot(aes(x = log(money_line_dec), y = factor(team_win), col = factor(team_win))) +
  geom_jitter(alpha = 0.5) 
   
```
###Is there a relationship between money_line_dec and team_win_ratio? 
```{r}
game_stats2 %>% 
  ggplot(aes(x = log(money_line_dec), y = log(team_win_ratio))) +
  geom_point(shape = 1, alpha = 0.5) +
  geom_smooth(method = "lm", se = F)
```

